# Releasing semi-automatically a new version of the Kubeapps Carvel package for TCE

## Dependencies

Most part of the package generation has been automated into a container, so very few dependencies are needed:

- Docker
- [GitHub CLI](https://cli.github.com/) for creating the release in the repository

## Build packager container image

If it is the first time generating the package, the packager container image needs to be created.
Run in the command line:

```bash
make build-packager-image
```

An image container named `kubeapps/carvel-packager` will be generated with all tooling needed.

## Repository push access

In addition, you also need permission to be able to push images to the relevant repositories of `projects-stg.registry.vmware.com` and `projects.registry.vmware.com`.

### Access to the production projects.registry.vmware.com kubeapps project

Both the staging and production distribution registries have the `tanzu-kubeapps-team` as an admin member for the `kubeapps` project, so you should have access to the project as long as you are a member of that group.

Although this already allows you to pull and push images to the project, you should create a bot account to authenticate and use with the script rather than your own credentials.

While connected to the VMware VPN, visit the Harbor instance at [projects.registry.vmware.com](https://projects.registry.vmware.com) and login with your vmware credentials (your username without email). Search for the kubeapps project, for which you should find you have an Admin role (as part of `tanzu-kubeapps-team`), select the project and you will be presented with the single kubeapps/kubeapps repository.

Click on the Robot Accounts tab then New Robot Account and create a bot account with a name such as `release-bot-local-<your username>` with an appropriate expiry.
Export the user and secret into environment variables in a terminal window:

```bash
export REGISTRY_USER='robot$kubeapps+release-bot-local-<your-username>'
export REGISTRY_TOKEN='<your-generated-token>'
```

> Make sure to use single quotes `'` instead of double quotes `"` to avoid variable evaluation in case the user/token contains special characters (e.g. `$`).

### Access to the staging repository

A similar process is now used for the staging harbor instance at [projects-stg.registry.vmware.com](https://projects-stg.registry.vmware.com) since we now have access to an identical kubeapps project on the staging service.

## Generating the package

Package will be generated by the packager container pushing to the staging (or production) registry while connected to the VPN (See [Issue #12](https://github.com/vmware-tanzu/package-for-kubeapps/issues/12) for enabling testing the release project with other OCI registries).

Packager container will **not** commit the package to the Git repository and generate the release. This will be done by a separate script, outside of the container. See [Generating the package release](#generating-the-release).

The following example runs the packager for the `10.2.2` version of the Kubeapps Bitnami chart to staging. It uses an explicit suffix for the package version (`-dev1`) only because the `10.2.2` version of the package already exists. Ensure first that:

- The version you want to package is already cached in your local helm cache (`helm repo update && helm search repo kubeapps`),
- `kind` network exists in Docker (run `docker inspect kind`)

To generate the package and push it to the OCI registry, run in the terminal window where `REGISTRY_*` authentication variables are defined:

```bash
PACKAGE_VERSION=10.2.2 PACKAGE_VERSION_SUFFIX='-dev1' make package-stg
```

Similarly, the following example runs the packager for the 10.3.0 version and pushes it to production.

```bash
PACKAGE_VERSION=10.3.0 make package-prd
```

At this point, the generated local files will not be committed or tagged nor will a GitHub release have been created.
You can delete the generated files to put your local git repository back to its initial state:

```bash
PACKAGE_VERSION=10.3.0 make clear
```

## Generating the release

For a production release, **after the package generation step for production**, you will need to locally run the script `release-kubeapps-package.sh` which, in addition to pushing the image to the production registry, will also add, commit and tag the new files locally, push the tag to the `upstream` remote and create the release.

This step has been left outside of the container to be run locally due to the Git and GitHub operations that need to be done tied to a GitHub user.

In order to create a new package release, run:

```bash
./release-kubeapps-package.sh 10.3.0
```

The script does not currently push your updated branch (only the tag) with the new commits upstream, see [Issue 20](https://github.com/vmware-tanzu/package-for-kubeapps/issues/20).

## Updating the TCE repository to include the new package

Once we've published a new package to the production registry, we need to request that the new package be included in the TCE repository via a pull-request.

The [initial pull-request to include Kubeapps in the TCE repository](https://github.com/vmware-tanzu/community-edition/pull/4666) added:

- `addons/packages/kubeapps/metadata.yaml` - the metadata which tends not to change with new versions,
- `addons/packages/kubeapps/vendir.yml` - a vendir configuration which specifies the GitHub release from which to pull the README.md and `package.yaml` and where to place them.

The vendir tool was then run in the `addons/packages/kubeapps` directory to ensure all files are in place, before committing and creating the PR.

Subsequent updates for the Kubeapps package in TCE will involve modifying the `vendir.yml` to add a new path for the next release and re-running vendir before creating the PR. You can see example PRs like this for other packages, such as the [update PR for the FluxCD Helm Controller package](https://github.com/vmware-tanzu/community-edition/pull/4611/files) which adds a new `path` to the vendir.yml which is vendir'd as well as a minor manual update to the metadata.yaml (adding an icon).

## Overview of the packaging script

The functionality for creating, testing and publishing a new Kubeapps carvel package is contained primarily in the [package-kubeapps-version.sh bash script](./package-kubeapps-version.sh), with the test-related functionality in the separate [test/testing-lib.sh](./test/testing-lib.sh). Git operations and release creation in GitHub is contained in the [release-kubeapps-package.sh bash script](./release-kubeapps-package.sh).

Where possible, effort has been made to utilise the related carvel tooling such as vendir, ytt and imgpkg.

A number of [remaining improvements to the packaging release process have been documented as issues](https://github.com/vmware-tanzu/package-for-kubeapps/issues) but have not yet been raised in priority.

The functionality of the script is based on the [recommendations of the TCE packaging documentation](https://github.com/vmware-tanzu/community-edition/tree/main/docs/packaging).
